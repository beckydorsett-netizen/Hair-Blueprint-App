<!-- Chosen Palette: Warm Stone with Purple, Pink, Red, Teal, and Amber Accents for color-coding. -->
<!-- This Single Page Application (SPA) uses Firebase Firestore for authentication and data persistence (storing last selections and daily routine logs). -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Advanced Hair Blueprint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .styled-header {
            font-family: 'Playfair Display', serif;
        }
        /* --- MAIN TAB BUTTONS STYLING --- */
        .tab-button {
            transition: all 0.3s ease;
            /* Added mx-1 and fixed width for separation */
            @apply flex-1 px-4 py-3 text-sm md:text-base font-bold rounded-lg focus:outline-none focus:ring-4 focus:ring-purple-400 shadow-md transition-all duration-300 mx-1 border border-stone-300;
            max-width: 25%; /* Adjusted max-width for 4 buttons */
        }
        .tab-button.active {
            @apply bg-purple-700 text-white shadow-inner border-purple-700;
        }
        .tab-button:not(.active) {
            @apply text-stone-700 bg-white hover:bg-purple-50;
        }
        /* ACCORDION HEADER (Heading as a Button/Link) */
        .accordion-header {
            @apply flex justify-between items-center w-full px-6 py-4 cursor-pointer text-xl font-bold rounded-t-xl transition-colors duration-300;
        }
        .accordion-header.active {
            @apply bg-purple-100 text-purple-800;
        }
        .accordion-header:not(.active) {
            @apply bg-stone-100 text-stone-700 hover:bg-stone-200;
        }
        .accordion-content {
            @apply p-6 pt-4 border-t border-stone-200;
        }
        /* PROTOCOL BUTTONS (Default Base) */
        .protocol-button {
            transition: all 0.3s ease;
            @apply w-full sm:w-auto px-6 py-4 text-base md:text-lg font-semibold rounded-xl shadow-lg border focus:outline-none focus:ring-4 flex-grow;
        }

        /* --- WASH DAY BUTTON STYLING (STEP 1) --- */
        .wash-button { @apply border-2; }
        .wash-button[data-protocol="bond"]:not(.active) { @apply text-purple-700 border-purple-400 bg-white hover:bg-purple-50; }
        .wash-button[data-protocol="bond"].active { @apply bg-purple-700 border-purple-700 text-white shadow-inner focus:ring-purple-400; }
        .wash-button[data-protocol="shine"]:not(.active) { @apply text-red-600 border-red-400 bg-white hover:bg-red-50; }
        .wash-button[data-protocol="shine"].active { @apply bg-red-600 border-red-600 text-white shadow-inner focus:ring-red-400; }
        .wash-button[data-protocol="moisture"]:not(.active) { @apply text-teal-700 border-teal-400 bg-white hover:bg-teal-50; }
        .wash-button[data-protocol="moisture"].active { @apply bg-teal-700 border-teal-700 text-white shadow-inner focus:ring-teal-400; }
        .wash-button[data-protocol="reset"]:not(.active) { @apply text-amber-700 border-amber-400 bg-white hover:bg-amber-50; }
        .wash-button[data-protocol="reset"].active { @apply bg-amber-700 border-amber-700 text-white shadow-inner focus:ring-amber-400; }

        /* --- STYLE GOAL BUTTON STYLING (STEP 2) --- */
        .style-button { @apply border-pink-300; }
        .style-button.active { @apply bg-pink-600 border-pink-600 text-white shadow-inner focus:ring-pink-400; }
        .style-button[data-protocol="waves"]:not(.active) { @apply text-blue-700 bg-white hover:bg-pink-50; }
        .style-button[data-protocol="blowout"]:not(.active) { @apply text-indigo-700 bg-white hover:bg-pink-50; }
        .style-button[data-protocol="iron"]:not(.active) { @apply text-orange-700 bg-white hover:bg-pink-50; }
        .style-button[data-protocol="gel"]:not(.active) { @apply text-cyan-700 bg-white hover:bg-pink-50; }
        .style-button[data-protocol="texture"]:not(.active) { @apply text-lime-700 bg-white hover:bg-pink-50; }

        .card { @apply bg-white rounded-xl shadow-2xl; }
        .step-card { @apply bg-gradient-to-r from-purple-50 to-pink-50 border-l-4 border-purple-500 rounded-lg shadow-xl p-6 mt-6; }
        .step-card h3 { @apply text-2xl font-bold text-purple-800 mb-3; }
        .product-grid { @apply grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6; }
        
        /* --- PRODUCT CARD FOR ARSENAL --- */
        .product-card-enhanced {
            @apply bg-stone-50 rounded-xl shadow-lg p-5 border-t-4 border-pink-500 flex flex-col justify-between space-y-3;
        }
        .product-card-enhanced .product-name {
            @apply text-xl font-bold text-stone-800;
        }
        .product-card-enhanced .usage-note {
            @apply text-sm text-stone-600 border-b pb-3;
        }
        .link-button-group {
            @apply flex flex-col sm:flex-row gap-3 mt-4;
        }
        
        /* --- UPDATED LINK BUTTON STYLING (Matches Log Button) --- */
        .link-button-group a {
            /* Matched padding, font-weight, and size for prominence */
            @apply flex-1 text-center px-4 py-3 text-base font-bold rounded-lg transition duration-150 shadow-md; 
        }
        .price-link {
            @apply bg-purple-700 text-white hover:bg-purple-800;
        }
        .reorder-link {
            @apply bg-pink-600 text-white hover:bg-pink-700;
        }

        .quick-check-card { @apply card bg-purple-700 text-white p-6 mb-8; }
        .quick-check-card p { @apply text-lg; } /* Increased text size for readability */
        
        /* Custom list style for step cards */
        .step-card ol {
            @apply list-decimal list-inside space-y-2 text-stone-700 ml-4;
        }
        .step-card ol li {
            @apply text-base;
        }

        /* --- CALENDAR STYLING (FIXED WITH BOX-SHADOW) --- */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0; /* Remove gap to make borders contiguous */
        }
        
        /* APPLY BOX SHADOW FOR GRID LINES TO BOTH HEADERS AND CELLS */
        .day-header, .day-cell {
            /* Thickness reduced from 2px to 1px */
            box-shadow: 0 0 0 1px #1f2937 inset; 
        }

        .day-header {
            font-family: 'Playfair Display', serif; 
            /* Removed old border classes */
            @apply text-center text-sm font-extrabold text-purple-800 p-2 bg-purple-50;
        }
        .day-cell {
            /* Removed old border classes */
            @apply flex flex-col items-center justify-start p-1 sm:p-2 transition duration-150 cursor-pointer;
            position: relative;
            /* Aspect Ratio Trick for Square Cells */
            height: 0;
            padding-bottom: 100%;
            overflow: hidden; 
            box-sizing: border-box;
            display: block; /* Use block for absolute positioning of children */
        }
        
        /* Hover/Movable Highlight */
        .day-cell:hover:not(.outside-month) {
            @apply bg-purple-200 shadow-xl;
        }
        .day-cell.outside-month:hover {
            @apply cursor-default;
        }

        .day-cell > * {
            position: absolute;
            left: 0;
            right: 0;
            margin: 0 auto;
            text-align: center;
        }
        .day-number {
            /* Use a different font and bolden */
            font-family: 'Playfair Display', serif;
            @apply text-lg font-extrabold text-stone-900;
            top: 5px; 
            height: auto;
        }
        .day-routine {
            @apply text-xs font-semibold w-full px-1 py-0.5 rounded-md;
            bottom: 5px; 
            height: auto;
        }

        /* ROUTINE COLORS */
        .wash-bond { @apply bg-purple-100; }
        .wash-shine { @apply bg-red-100; }
        .wash-moisture { @apply bg-teal-100; }
        .wash-reset { @apply bg-amber-100; } /* Clarify Color */
        .non-wash { @apply bg-white; } /* Non-wash days (now blank) */
        .outside-month { @apply opacity-50 bg-stone-100; }

        /* HIGHLIGHTS */
        .today-highlight {
            /* Actual Live "Today" (subtle pink background) */
            @apply !bg-pink-100; 
            z-index: 10;
        }
        .selected-highlight {
            /* SELECTED DATE (Oct 22) - Reduced thickness from 6px to 3px and changed to inset */
            box-shadow: 0 0 0 3px #3b82f6 inset !important; /* Inner Blue Shadow (3px) */
            @apply !bg-blue-100;
            z-index: 11;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">

        <header class="text-center mb-10">
            <h1 class="text-5xl md:text-7xl styled-header font-extrabold text-purple-800">My Advanced Hair Blueprint</h1>
            <p class="text-lg text-stone-600 mt-3">Your personalized guide to healthy, vibrant, and perfectly styled hair.</p>
            <p id="auth-status" class="text-sm text-green-600 font-medium mt-2"></p>
        </header>

        <!-- MAIN TAB NAVIGATION (UPDATED FOR 4 TABS) -->
        <nav class="flex flex-wrap justify-center mb-12 space-x-1 md:space-x-4" role="tablist">
            <button id="tab-btn-protocol" role="tab" aria-selected="true" class="tab-button active">Daily Protocol</button>
            <button id="tab-btn-calendar" role="tab" aria-selected="false" class="tab-button">Monthly Calendar</button>
            <button id="tab-btn-weekly" role="tab" aria-selected="false" class="tab-button">Weekly View</button>
            <button id="tab-btn-arsenal" role="tab" aria-selected="false" class="tab-button">Product Arsenal</button>
        </nav>

        <main>
            <!-- DAILY PROTOCOL TAB CONTENT -->
            <div id="tab-panel-protocol" role="tabpanel" class="space-y-10">
                <p class="text-center text-stone-700 text-xl font-medium">Use the sections below to generate your steps: first select your Wash Routine, then your Style Goal.</p>

                <!-- QUICK CHECK WIDGET -->
                <div id="quick-check-widget" class="quick-check-card text-center">
                    <h2 class="text-3xl font-bold mb-2">Selected Day Routine (PST)</h2>
                    <p id="quick-check-date" class="text-lg font-semibold mb-3"></p>
                    <p>Suggested routine based on the 4-week cycle:</p>
                    <div id="suggested-day-display" class="text-4xl font-extrabold my-3 bg-white text-purple-800 rounded-lg p-3 mx-auto max-w-sm"></div>
                    <button id="use-suggested-btn" class="px-4 py-2 bg-pink-500 text-white rounded-lg font-semibold hover:bg-pink-600 transition duration-150 mt-3 shadow-md">Use Suggested Wash</button>
                </div>
                
                <!-- SELECTION STATUS DISPLAY (Floating Element) -->
                <div id="selection-status" class="mb-4 p-4 bg-stone-100 rounded-xl text-lg text-center font-bold border-l-4 border-purple-500 shadow-lg">
                    No Routine Selected. Please choose Step 1 and Step 2 above.
                </div>

                <!-- STEP 1: WASH ROUTINE ACCORDION -->
                <section class="card overflow-hidden">
                    <div id="accordion-wash-header" class="accordion-header active" data-target="accordion-wash-content">
                        <span>Step 1: Select Your Wash Routine</span>
                        <span id="accordion-wash-chevron" class="transform transition-transform duration-300">▼</span>
                    </div>
                    <div id="accordion-wash-content" class="accordion-content">
                        <div class="flex flex-wrap justify-center gap-4">
                            <button class="protocol-button wash-button" data-protocol="bond">Bond Repair Shine at HP</button>
                            <button class="protocol-button wash-button" data-protocol="shine">Shine & pH</button>
                            <button class="protocol-button wash-button" data-protocol="moisture">Deep Moisture</button>
                            <button class="protocol-button wash-button" data-protocol="reset">Clarify Reset</button>
                        </div>
                    </div>
                </section>

                <!-- STEP 2: STYLE GOAL ACCORDION -->
                <section class="card overflow-hidden">
                    <div id="accordion-style-header" class="accordion-header" data-target="accordion-style-content">
                        <span>Step 2: Select Your Style Goal</span>
                        <span id="accordion-style-chevron" class="transform transition-transform duration-300 rotate-90">►</span>
                    </div>
                    <div id="accordion-style-content" class="accordion-content hidden">
                        <div class="flex flex-wrap justify-center gap-4">
                            <button class="protocol-button style-button" data-protocol="waves">Defined Waves (Air-Dry)</button>
                            <button class="protocol-button style-button" data-protocol="blowout">Smooth Blowout (Heat)</button>
                            <button class="protocol-button style-button" data-protocol="iron">Hot Iron Finish (High-Heat)</button>
                            <button class="protocol-button style-button" data-protocol="gel">Strong Gel Cast (Air-Dry)</button>
                            <button class="protocol-button style-button" data-protocol="texture">Beachy Texture</button>
                        </div>
                    </div>
                </section>

                <!-- FINAL PROTOCOL DISPLAY & LOG BUTTON -->
                <section id="protocol-display" class="mt-8">
                    
                    <div id="wash-steps"></div>
                    <div id="style-steps"></div>
                    
                    <div id="log-section" class="card p-6 mt-8 text-center hidden">
                        <p class="text-xl font-bold text-stone-700 mb-4">Routine Selected!</p>
                        <div class="flex flex-col sm:flex-row justify-center gap-4">
                            <button id="log-completion-btn" class="flex-1 max-w-sm px-8 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition duration-150 shadow-md">
                                Log as Completed Today
                            </button>
                            
                            <!-- CLEAR SELECTION BUTTON -->
                            <button id="clear-selection-btn" class="flex-1 max-w-sm px-6 py-3 bg-stone-300 text-stone-800 rounded-lg font-bold hover:bg-stone-400 transition duration-150 shadow-md">
                                Clear Routine Selection
                            </button>
                        </div>
                        <p id="log-message" class="text-sm text-green-500 mt-2"></p>
                    </div>
                </section>
            </div>

            <!-- MONTHLY CALENDAR TAB CONTENT (NEW) -->
            <div id="tab-panel-calendar" role="tabpanel" class="hidden">
                <h2 class="text-3xl font-bold text-stone-800 mb-6 text-center styled-header">Wash Cycle Calendar (MWF - 4 Week Rotation)</h2>
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <button id="prev-month-btn" class="text-3xl font-bold text-purple-700 hover:text-purple-500">«</button>
                        <h3 id="calendar-month-year" class="text-3xl font-extrabold text-purple-700 mx-4"></h3>
                        <button id="next-month-btn" class="text-3xl font-bold text-purple-700 hover:text-purple-500">»</button>
                    </div>
                    
                    <div id="calendar-grid">
                        <!-- Headers and cells are generated here by JS render function -->
                    </div>
                    <div class="mt-6 flex justify-center gap-4 flex-wrap text-sm font-medium">
                        <span class="flex items-center"><div class="w-3 h-3 rounded-full bg-purple-700 mr-2"></div> Bond Repair Shine at HP</span>
                        <span class="flex items-center"><div class="w-3 h-3 rounded-full bg-red-600 mr-2"></div> Shine & pH</span>
                        <span class="flex items-center"><div class="w-3 h-3 rounded-full bg-teal-700 mr-2"></div> Deep Moisture</span>
                        <span class="flex items-center"><div class="w-3 h-3 rounded-full bg-amber-700 mr-2"></div> Clarify Reset (Detox)</span>
                        <span class="flex items-center"><div class="w-3 h-3 rounded-full bg-white border border-stone-300 mr-2"></div> No Wash</span>
                    </div>
                </div>
            </div>

            <!-- WEEKLY VIEW TAB CONTENT (UPDATED FOR 4-WEEK CYCLE) -->
            <div id="tab-panel-weekly" role="tabpanel" class="hidden">
                <h2 class="text-3xl font-bold text-stone-800 mb-6 text-center styled-header">The 4-Week Rotating Wash & Treatment Cycle</h2>
                <p class="text-lg text-stone-700 text-center mb-8">This is your 12-day rotating foundation. The cycle repeats after the **Clarify Reset** (on the 4th Friday wash).</p>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="card border-t-4 border-purple-700 p-6">
                        <h3 class="text-2xl font-bold text-purple-700 mb-3">Bond Repair Shine at HP (Cycle 1, 4, 7, 10)</h3>
                        <p class="text-stone-600 mb-4">Rebuilds internal strength from color damage.</p>
                        <ol class="list-decimal list-inside space-y-2 text-stone-700 ml-4">
                            <li>(Optional, bi-weekly) Pre-wash with **Olaplex No. 3**.</li>
                            <li>Wash with **Olaplex No. 4**.</li>
                            <li>Condition with **Olaplex No. 5**.</li>
                        </ol>
                    </div>
                    <div class="card border-t-4 border-red-600 p-6">
                        <h3 class="text-2xl font-bold text-red-600 mb-3">Shine & pH (Cycle 2, 5, 8, 11)</h3>
                        <p class="text-stone-600 mb-4">Seals the cuticle for color vibrancy and shine.</p>
                        <ol class="list-decimal list-inside space-y-2 text-stone-700 ml-4">
                            <li>Wash with **EverPure Glossing Shampoo**.</li>
                            <li>Apply **EverPure Glossing Glaze** (wait 2-3 mins).</li>
                            <li>Layer **EverPure Glossing Conditioner** on top, then rinse.</li>
                        </ol>
                    </div>
                    <div class="card border-t-4 border-teal-700 p-6">
                        <h3 class="text-2xl font-bold text-teal-700 mb-3">Deep Moisture (Cycle 3, 6, 9)</h3>
                        <p class="text-stone-600 mb-4">Focuses on hydration, softness, and frizz control.</p>
                        <ol class="list-decimal list-inside space-y-2 text-stone-700 ml-4">
                            <li>Wash with **EverPure Deep Nourish Shampoo**.</li>
                            <li>Apply **EverPure 5-Min Lamination Mask** (*replaces* conditioner).</li>
                        </ol>
                    </div>
                     <div class="card border-t-4 border-amber-700 p-6">
                        <h3 class="text-2xl font-bold text-amber-700 mb-3">Clarify Reset (Cycle 12)</h3>
                        <p class="text-stone-600">This is the **12th wash day** (once per 4 weeks) to remove buildup and minerals.</p>
                        <ol class="list-decimal list-inside space-y-2 text-stone-700 mt-4 ml-4">
                            <li>Wash with **OGX Clarifying Shampoo** twice to remove all product and mineral buildup.</li>
                            <li>Follow with **EverPure 5-Min Lamination Mask** to restore moisture.</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- PRODUCT ARSENAL TAB CONTENT (Enhanced) -->
            <div id="tab-panel-arsenal" role="tabpanel" class="hidden space-y-8">
                <h2 class="text-3xl font-bold text-stone-800 mb-6 text-center styled-header">My Product Arsenal</h2>
                <p class="text-lg text-stone-700 text-center mb-8">A complete reference of all your products, including usage and reorder links.</p>

                <!-- Link Editing Explanation -->
                <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-8">
                    <p class="font-bold">Pro Tip: Link Management</p>
                    <p class="text-sm">You can edit the product links (URLs) directly in the **`productData` array** in the script section below to keep your links up-to-date!</p>
                </div>

                <div id="product-arsenal-display">
                    <!-- Products will be generated here by JS -->
                </div>
            </div>
        </main>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, Timestamp, setLogLevel, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DEMO OVERRIDE FOR USER CONTEXT ---
        // Setting the demo date to Wednesday, October 22, 2025 (PST) as requested.
        const DEMO_DATE_PST_STRING = '2025-10-22';

        // Reference date for the 12-day cycle: Monday, 10/20/2025.
        // This makes 10/22/2025 (Wednesday) fall on Wash Day 2 (Shine & pH).
        // Note: All date logic below treats this as the "current day" for the demo.
        const REFERENCE_DATE = new Date('2025-10-20T12:00:00Z'); 
        
        // Utility function to get YYYY-MM-DD date string in PST (California time)
        const getTodayDateStringPST = () => {
            // In a live environment, this returns the *actual* PST date.
            const date = new Date();
            const formatter = new Intl.DateTimeFormat('en-CA', { 
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZone: 'America/Los_Angeles'
            });
            return formatter.format(date).replace(/(\d{4})\/(\d{2})\/(\d{2})/, '$1-$2-$3'); // ensure YYYY-MM-DD format
        };
        
        // We use the live date for the log, but the demo date for the UI context
        const LIVE_PST_DATE = getTodayDateStringPST(); 
        const TODAY_PST_DATE = DEMO_DATE_PST_STRING; // Using the user's date for demo context

        // Utility function to get YYYY-MM-DD date string from a Date object
        const getDateString = (date) => date.toISOString().split('T')[0];
        
        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        const SETTINGS_DOC_PATH = (uid) => `/artifacts/${appId}/users/${uid}/hair-blueprint-settings/lastSelection`;
        const LOG_COLLECTION_PATH = (uid) => `/artifacts/${appId}/users/${uid}/hair-blueprint-log`;

        let currentWash = null;
        let currentStyle = null;
        
        // State Variables for Calendar and Selection
        let currentCalendarMonthOffset = 0;
        let selectedDateString = TODAY_PST_DATE; // Date currently highlighted on calendar/quick-check
        let logData = {}; // Cache for logged routines (date: {wash, style})

        // Adjust the calendar offset to show the month of the demo date (October 2025)
        const initialDate = new Date();
        const demoDate = new Date(DEMO_DATE_PST_STRING.replace(/-/g, '/'));
        currentCalendarMonthOffset = (demoDate.getFullYear() - initialDate.getFullYear()) * 12 + (demoDate.getMonth() - initialDate.getMonth());


        // --- CORE APPLICATION DATA (COMPLETED) ---

        const WASH_CYCLE = [
            { id: 'bond', name: 'Bond Repair Shine at HP' },    // Wash 1
            { id: 'shine', name: 'Shine & pH' },              // Wash 2
            { id: 'moisture', name: 'Deep Moisture' },        // Wash 3
            { id: 'bond', name: 'Bond Repair Shine at HP' },    // Wash 4
            { id: 'shine', name: 'Shine & pH' },              // Wash 5
            { id: 'moisture', name: 'Deep Moisture' },        // Wash 6
            { id: 'bond', name: 'Bond Repair Shine at HP' },    // Wash 7
            { id: 'shine', name: 'Shine & pH' },              // Wash 8
            { id: 'moisture', name: 'Deep Moisture' },        // Wash 9
            { id: 'bond', name: 'Bond Repair Shine at HP' },    // Wash 10
            { id: 'shine', name: 'Shine & pH' },              // Wash 11
            { id: 'reset', name: 'Clarify Reset' },            // Wash 12 (Detox/Cycle End)
        ];
        
        const washProtocols = {
            bond: { steps: `
                <div class="step-card bg-gradient-to-r from-purple-100 to-white border-purple-700">
                    <h3>Wash Steps: Bond Repair Shine at HP</h3>
                    <p class="text-sm text-purple-700 font-semibold mb-3">Goal: Rebuild internal strength and prevent breakage.</p>
                    <ol>
                        <li>(Optional, bi-weekly) Pre-wash with **Olaplex No. 3** for 10 minutes.</li>
                        <li>Wash with **Olaplex No. 4** (Bond Shampoo), focusing on the scalp.</li>
                        <li>Condition with **Olaplex No. 5** (Bond Conditioner) on mid-lengths to ends. Detangle gently.</li>
                    </ol>
                </div>`, color: 'purple' },
            shine: { steps: `
                <div class="step-card bg-gradient-to-r from-red-100 to-white border-red-600">
                    <h3>Wash Steps: Shine & pH</h3>
                    <p class="text-sm text-red-700 font-semibold mb-3">Goal: Seal the cuticle for color vibrancy and mirror-like shine.</p>
                    <ol>
                        <li>Wash with **EverPure Glossing Shampoo** for a deep cleanse.</li>
                        <li>Apply **EverPure Glossing Glaze** (wait 2-3 mins). Do not rinse.</li>
                        <li>Layer **EverPure Glossing Conditioner** on top, then rinse both together.</li>
                    </ol>
                </div>`, color: 'red' },
            moisture: { steps: `
                <div class="step-card bg-gradient-to-r from-teal-100 to-white border-teal-700">
                    <h3>Wash Steps: Deep Moisture</h3>
                    <p class="text-sm text-teal-700 font-semibold mb-3">Goal: Hydration, softness, and maximum frizz control.</p>
                    <ol>
                        <li>Wash with **EverPure Deep Nourish Shampoo**.</li>
                        <li>Apply **EverPure 5-Min Lamination Mask** (*replaces* conditioner). Finger-rake through, leave for 5 mins, then rinse.</li>
                    </ol>
                </div>`, color: 'teal' },
            reset: { steps: `
                <div class="step-card bg-gradient-to-r from-amber-100 to-white border-amber-700">
                    <h3>Wash Steps: Clarify Reset (Detox)</h3>
                    <p class="text-sm text-amber-700 font-semibold mb-3">Goal: Remove all product and mineral buildup. Performed once per 4-week cycle.</p>
                    <ol>
                        <li>Wash with **OGX Clarifying Shampoo** (must be done twice).</li>
                        <li>Follow immediately with **EverPure 5-Min Lamination Mask** to restore moisture, leaving for 5 mins before rinsing.</li>
                    </ol>
                </div>`, color: 'amber' }
        };

        const styleGoals = {
            waves: { name: "Defined Waves (Air-Dry)", steps: `
                <div class="step-card bg-gradient-to-r from-pink-100 to-white border-pink-500">
                    <h3>Style Steps: Defined Waves (Air-Dry)</h3>
                    <ol>
                        <li>While soaking wet, rake through **Olaplex No. 6** (Bond Smoother) and **No. 9** (Bond Serum).</li>
                        <li>Apply a generous amount of **Olaplex No. 7** (Oil) to seal.</li>
                        <li>Scrunch gently and air-dry or diffuse on low/medium heat.</li>
                    </ol>
                </div>` },
            blowout: { name: "Smooth Blowout (Heat)", steps: `
                <div class="step-card bg-gradient-to-r from-pink-100 to-white border-pink-500">
                    <h3>Style Steps: Smooth Blowout (Heat)</h3>
                    <ol>
                        <li>Apply **Olaplex No. 6** (Bond Smoother) evenly to damp hair for heat protection and smoothness.</li>
                        <li>Mist with **TRESemmé Heat Protectant**.</li>
                        <li>Blow-dry using a round brush until 100% dry. Finish with a small amount of **Olaplex No. 7** (Oil) on the ends.</li>
                    </ol>
                </div>` },
            iron: { name: "Hot Iron Finish (High-Heat)", steps: `
                <div class="step-card bg-gradient-to-r from-pink-100 to-white border-pink-500">
                    <h3>Style Steps: Hot Iron Finish (High-Heat)</h3>
                    <ol>
                        <li>Apply **Olaplex No. 6** to damp hair. Rough dry 100%.</li>
                        <li>Apply liberal amount of **TRESemmé Heat Protectant** before using the hot tool.</li>
                        <li>Style with flat iron or curling iron. Finish with a light spritz of **TRESemmé Hairspray**.</li>
                    </ol>
                </div>` },
            gel: { name: "Strong Gel Cast (Air-Dry)", steps: `
                <div class="step-card bg-gradient-to-r from-pink-100 to-white border-pink-500">
                    <h3>Style Steps: Strong Gel Cast (Air-Dry)</h3>
                    <ol>
                        <li>Apply **Olaplex No. 6** to wet hair.</li>
                        <li>Use **Aussie Instant Freeze Gel** to create a strong cast (clumps).</li>
                        <li>Air-dry completely. Scrunch out the crunch (SOTC) with a few drops of **Olaplex No. 7** (Oil).</li>
                    </ol>
                </div>` },
            texture: { name: "Beachy Texture", steps: `
                <div class="step-card bg-gradient-to-r from-pink-100 to-white border-pink-500">
                    <h3>Style Steps: Beachy Texture</h3>
                    <ol>
                        <li>Rough-dry hair to 80% dampness.</li>
                        <li>Spray **Not Your Mother's Beach Babe** throughout. Gently scrunch and let air-dry.</li>
                        <li>For volume, finish with a small amount of **TRESemmé Hairspray** on the roots.</li>
                    </ol>
                </div>` }
        };

        const productData = [
            { name: "Olaplex No. 3 Hair Perfector", type: "Bond Treatment", usage: "Pre-wash, bi-weekly or as needed.", priceLink: "https://shop.olaplex.com/no.3-hair-perfector", reorderLink: "https://amzn.to/olaplex3" },
            { name: "Olaplex No. 4 Bond Maintenance Shampoo", type: "Bond/Wash", usage: "Used in the Bond routine.", priceLink: "https://shop.olaplex.com/no.4-shampoo", reorderLink: "https://amzn.to/olaplex4" },
            { name: "Olaplex No. 5 Bond Maintenance Conditioner", type: "Bond/Conditioner", usage: "Used in the Bond routine.", priceLink: "https://shop.olaplex.com/no.5-conditioner", reorderLink: "https://amzn.to/olaplex5" },
            { name: "Olaplex No. 6 Bond Smoother", type: "Leave-In", usage: "Reduces frizz and acts as heat protection primer.", priceLink: "https://shop.olaplex.com/no.6-bond-smoother", reorderLink: "https://amzn.to/olaplex6" },
            { name: "Olaplex No. 7 Bonding Oil", type: "Finishing Oil", usage: "Adds shine, seals ends, SOTC.", priceLink: "https://shop.olaplex.com/no.7-bonding-oil", reorderLink: "https://amzn.to/olaplex7" },
            { name: "Olaplex No. 9 Bond Protector Nourishing Hair Serum", type: "Serum/Primer", usage: "Antioxidant protection and light hold.", priceLink: "https://shop.olaplex.com/no.9-serum", reorderLink: "https://amzn.to/olaplex9" },
            { name: "EverPure Glossing Shampoo", type: "Shine/Wash", usage: "Used in the Shine routine.", priceLink: "https://www.lorealparisusa.com/gloss-shampoo", reorderLink: "https://amzn.to/gloss-shampoo" },
            { name: "EverPure Glossing Glaze", type: "Shine/Treatment", usage: "Used after shampoo in Shine routine to seal cuticle.", priceLink: "https://www.lorealparisusa.com/gloss-glaze", reorderLink: "https://amzn.to/gloss-glaze" },
            { name: "EverPure Glossing Conditioner", type: "Shine/Conditioner", usage: "Used in the Shine routine.", priceLink: "https://www.lorealparisusa.com/gloss-conditioner", reorderLink: "https://amzn.to/gloss-cond" },
            { name: "EverPure Deep Nourish Shampoo", type: "Moisture/Wash", usage: "Used in the Deep Moisture routine.", priceLink: "https://www.lorealparisusa.com/nourish-shampoo", reorderLink: "https://amzn.to/nourish-shampoo" },
            { name: "EverPure 5-Min Lamination Mask", type: "Moisture/Mask", usage: "Primary moisturizer; replaces conditioner in Moisture/Reset.", priceLink: "https://www.lorealparisusa.com/lamination-mask", reorderLink: "https://amzn.to/lamination-mask" },
            { name: "OGX Purifying + Tea Tree Mint Shampoo", type: "Clarifying/Wash", usage: "Used for the Clarify Reset (Detox) wash.", priceLink: "https://www.ogxbeauty.com/clarifying-shampoo", reorderLink: "https://amzn.to/ogx-clarify" },
            { name: "TRESemmé Thermal Creations Heat Protectant Spray", type: "Heat Protection", usage: "Essential before any heat tool (blowout, iron).", priceLink: "https://www.tresemme.com/heat-protectant", reorderLink: "https://amzn.to/tresemme-heat" },
            { name: "TRESemmé TRES TWO Hairspray", type: "Hold/Finish", usage: "Light hold for Hot Iron or volume in Texture.", priceLink: "https://www.tresemme.com/hairspray", reorderLink: "https://amzn.to/tresemme-spray" },
            { name: "Aussie Instant Freeze Gel", type: "Strong Hold Gel", usage: "Used for the Strong Gel Cast style goal.", priceLink: "https://www.aussie.com/instant-freeze-gel", reorderLink: "https://amzn.to/aussie-gel" },
            { name: "Not Your Mother's Beach Babe Texturizing Spray", type: "Texturizer", usage: "Used for Beachy Texture style goal.", priceLink: "https://www.nymbrands.com/beach-babe", reorderLink: "https://amzn.to/nym-beach" },
        ];


        // --- 4-WEEK CYCLE CALCULATION LOGIC (NEW) ---

        /**
         * Calculates the wash cycle for a given date.
         * @param {string} dateString - YYYY-MM-DD format.
         * @returns {{id: string, name: string} | null} - The wash day protocol or null if no wash day.
         */
        const getWashDayData = (dateString) => {
            const date = new Date(dateString.replace(/-/g, '/'));
            const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday, 5=Friday, 6=Saturday

            // Only wash on Monday (1), Wednesday (3), Friday (5)
            if (dayOfWeek !== 1 && dayOfWeek !== 3 && dayOfWeek !== 5) {
                return null;
            }

            // 1. Calculate days since the reference date
            // We use floor to ensure consistent day counting, and convert to days
            const diffTime = date.getTime() - REFERENCE_DATE.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // 2. Count M, W, F washes in that period
            let washCount = 0;
            for (let i = 0; i <= diffDays; i++) {
                const checkDate = new Date(REFERENCE_DATE);
                checkDate.setDate(REFERENCE_DATE.getDate() + i);
                const day = checkDate.getDay();
                if (day === 1 || day === 3 || day === 5) {
                    washCount++;
                }
            }

            // The wash day index is based on the 12-day cycle.
            // Since washCount starts at 1 for the reference date (Wash 1), we use (count - 1) % 12
            const cycleIndex = (washCount - 1) % WASH_CYCLE.length;

            // 3. Return the protocol for the current wash day
            return WASH_CYCLE[cycleIndex];
        };
        
        const loadLogData = async () => {
            if (!userId || userId.startsWith('guest-')) return;

            try {
                const logsRef = collection(db, LOG_COLLECTION_PATH(userId));
                const q = query(logsRef); // Simple query to get all logs
                const snapshot = await getDocs(q);

                logData = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    logData[data.date] = { wash: data.wash, style: data.style, logged: true };
                });
                renderCalendar(); // Re-render calendar with new log data
            } catch (e) {
                console.error("Error loading log data:", e);
            }
        };


        // --- FIREBASE INITIALIZATION & AUTH ---
        const setupFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase config missing. Using anonymous mode.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Enable for detailed logging

                const authStatusEl = document.getElementById('auth-status');
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `User ID: ${userId} | Status: Ready`;
                        await loadLastSelection();
                    } else {
                        // Fallback for unauthenticated users 
                        userId = 'guest-' + (window.crypto.randomUUID ? window.crypto.randomUUID() : Math.random().toString(36).substring(2));
                        authStatusEl.textContent = `Status: Guest Mode (ID: ${userId.substring(0, 8)}...)`;
                        loadLastSelectionFromLocalStorage();
                    }
                    await loadLogData();
                    initializeUI();
                });

            } catch (error) {
                console.error("Firebase setup failed:", error);
                document.getElementById('auth-status').textContent = `Authentication Error: ${error.message.substring(0, 50)}...`;
                // Fallback for broken Firebase setup
                userId = 'guest-' + (window.crypto.randomUUID ? window.crypto.randomUUID() : Math.random().toString(36).substring(2));
                initializeUI();
            }
        };
        
        // --- DATA PERSISTENCE HANDLERS (UPDATED TO INCLUDE LOGS) ---
        const saveLastSelection = async () => {
            if (!userId) return; 
            
            const selection = {
                wash: currentWash,
                style: currentStyle,
                timestamp: Timestamp.now()
            };

            if (userId.startsWith('guest-')) {
                localStorage.setItem('hair-blueprint-last', JSON.stringify(selection));
                return;
            }

            try {
                const docRef = doc(db, SETTINGS_DOC_PATH(userId));
                await setDoc(docRef, selection, { merge: true });
            } catch (e) {
                console.error("Error saving document:", e);
            }
        };

        const loadLastSelection = async () => {
            if (!userId || userId.startsWith('guest-')) {
                 loadLastSelectionFromLocalStorage();
                 return;
            }
            try {
                const docRef = doc(db, SETTINGS_DOC_PATH(userId));
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentWash = data.wash || null;
                    currentStyle = data.style || null;
                    applySelectionsToUI();
                }
            } catch (e) {
                console.error("Error loading document:", e);
            }
        };

        const loadLastSelectionFromLocalStorage = () => {
            const stored = localStorage.getItem('hair-blueprint-last');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    currentWash = data.wash || null;
                    currentStyle = data.style || null;
                    applySelectionsToUI();
                } catch (e) {
                    console.warn("Failed to parse local storage data.");
                }
            }
        };

        const logCompletion = async () => {
            if (!currentWash || !currentStyle) return;

            const today = LIVE_PST_DATE; // Use live PST date for logging
            const logMessageEl = document.getElementById('log-message');

            if (userId.startsWith('guest-')) {
                logMessageEl.textContent = `Routine logged locally for ${today}! (Note: Log will disappear on refresh in Guest Mode)`;
                return;
            }

            try {
                // Check if already logged today
                const logsRef = collection(db, LOG_COLLECTION_PATH(userId));
                const logQuery = query(logsRef, where("date", "==", today));
                const querySnapshot = await getDocs(logQuery);

                if (!querySnapshot.empty) {
                    logMessageEl.textContent = `You already logged a routine for ${today}!`;
                    return;
                }

                await addDoc(logsRef, {
                    wash: currentWash,
                    style: currentStyle,
                    date: today,
                    timestamp: Timestamp.now()
                });
                logMessageEl.textContent = `Routine successfully logged for ${today}! Great job!`;
                // Update local log cache and re-render
                logData[today] = { wash: currentWash, style: currentStyle, logged: true };
                renderCalendar();
            } catch (e) {
                console.error("Error logging completion:", e);
                logMessageEl.textContent = `Error logging completion. Please check console.`;
            }
        };

        // --- UI RENDERING FUNCTIONS (COMPLETED) ---

        const updateProtocolDisplay = () => {
            const washStepsEl = document.getElementById('wash-steps');
            const styleStepsEl = document.getElementById('style-steps');
            const logSectionEl = document.getElementById('log-section');
            const statusEl = document.getElementById('selection-status');
            const logMessageEl = document.getElementById('log-message');

            washStepsEl.innerHTML = currentWash ? washProtocols[currentWash].steps : '';
            styleStepsEl.innerHTML = currentStyle ? styleGoals[currentStyle].steps : '';
            logMessageEl.textContent = ''; // Clear status message

            if (currentWash && currentStyle) {
                logSectionEl.classList.remove('hidden');
                statusEl.innerHTML = `**Current Routine:** ${WASH_CYCLE.find(w => w.id === currentWash).name || currentWash} / ${styleGoals[currentStyle].name}`;
                statusEl.classList.remove('border-purple-500');
                statusEl.classList.add('border-green-500');
            } else {
                logSectionEl.classList.add('hidden');
                statusEl.innerHTML = 'No Routine Selected. Please choose Step 1 and Step 2 above.';
                statusEl.classList.remove('border-green-500');
                statusEl.classList.add('border-purple-500');
            }
        };

        const applySelectionsToUI = () => {
            document.querySelectorAll('.wash-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.protocol === currentWash);
            });
            document.querySelectorAll('.style-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.protocol === currentStyle);
            });
            updateProtocolDisplay();
        };

        const renderProductArsenal = () => {
            const container = document.getElementById('product-arsenal-display');
            container.className = 'product-grid';
            container.innerHTML = productData.map(p => `
                <div class="product-card-enhanced">
                    <div class="mb-4">
                        <span class="text-sm font-medium text-pink-600 bg-pink-100 px-3 py-1 rounded-full">${p.type}</span>
                        <p class="product-name mt-2">${p.name}</p>
                        <p class="usage-note">${p.usage}</p>
                    </div>
                    <div class="link-button-group">
                        <a href="${p.priceLink}" target="_blank" class="price-link">View Price</a>
                        <a href="${p.reorderLink}" target="_blank" class="reorder-link">Reorder (Quick)</a>
                    </div>
                </div>
            `).join('');
        };


        // --- CALENDAR FUNCTIONS (NEW) ---

        const renderCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            const monthYearEl = document.getElementById('calendar-month-year');
            grid.innerHTML = '';
            
            // Determine the current month being viewed
            const displayDate = new Date(TODAY_PST_DATE.replace(/-/g, '/'));
            displayDate.setMonth(displayDate.getMonth() + currentCalendarMonthOffset);
            displayDate.setDate(1);

            const currentMonth = displayDate.getMonth();
            const currentYear = displayDate.getFullYear();
            monthYearEl.textContent = displayDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Start day of the week (0 = Sunday)
            const startDay = displayDate.getDay();

            // Days in month
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Day Headers (Static)
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                grid.insertAdjacentHTML('beforeend', `<div class="day-header">${day}</div>`);
            });

            // Loop through preceding month days (if needed)
            for (let i = 0; i < startDay; i++) {
                grid.insertAdjacentHTML('beforeend', `<div class="day-cell outside-month"></div>`);
            }

            // Loop through current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateString = getDateString(date);

                const washData = getWashDayData(dateString);
                const routineId = washData ? washData.id : 'non-wash';
                const routineName = washData ? washData.name.split(' ')[0] : '';
                const bgColor = `wash-${routineId}`;
                
                let classes = `day-cell ${bgColor}`;

                // Highlight the current UI focus date
                if (dateString === selectedDateString) {
                    classes += ' selected-highlight';
                }

                // Highlight the actual live "Today" date
                if (dateString === TODAY_PST_DATE) {
                    classes += ' today-highlight';
                }
                
                // Check logs
                const logIndicator = logData[dateString] ? '<span class="text-xs text-green-700 bg-green-200 rounded-full px-2 mt-1">Logged</span>' : '';


                grid.insertAdjacentHTML('beforeend', `
                    <div class="${classes}" data-date="${dateString}">
                        <span class="day-number">${day}</span>
                        <div class="day-routine ${washData ? 'text-stone-700' : 'text-stone-400'}">
                            ${routineName}
                        </div>
                        ${logIndicator}
                    </div>
                `);
            }

            // Add event listeners for day cells
            document.querySelectorAll('.day-cell').forEach(cell => {
                if (!cell.classList.contains('outside-month')) {
                    cell.addEventListener('click', (e) => {
                        selectedDateString = e.currentTarget.dataset.date;
                        renderCalendar(); // Re-render to highlight selection
                        updateQuickCheck(); // Update the Quick Check widget
                    });
                }
            });
        };
        
        const updateQuickCheck = () => {
            const date = new Date(selectedDateString.replace(/-/g, '/'));
            const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
            const formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            document.getElementById('quick-check-date').textContent = `${dayName}, ${formattedDate}`;

            const washData = getWashDayData(selectedDateString);
            const suggestedDisplay = document.getElementById('suggested-day-display');
            const useSuggestedBtn = document.getElementById('use-suggested-btn');

            if (washData) {
                suggestedDisplay.textContent = washData.name;
                suggestedDisplay.className = `text-4xl font-extrabold my-3 bg-${washProtocols[washData.id].color}-50 text-${washProtocols[washData.id].color}-800 rounded-lg p-3 mx-auto max-w-sm`;
                useSuggestedBtn.classList.remove('hidden');
                useSuggestedBtn.onclick = () => {
                    currentWash = washData.id;
                    saveLastSelection();
                    applySelectionsToUI();
                    // Switch to Protocol Tab
                    switchTab('protocol');
                    // Collapse calendar view if open
                    if (!document.getElementById('accordion-wash-content').classList.contains('hidden')) {
                        toggleAccordion('accordion-wash-header');
                    }
                    if (document.getElementById('accordion-style-content').classList.contains('hidden')) {
                        toggleAccordion('accordion-style-header');
                    }
                };
            } else {
                suggestedDisplay.textContent = 'Non-Wash Day (No Suggested Routine)';
                suggestedDisplay.className = 'text-2xl font-extrabold my-3 bg-stone-200 text-stone-700 rounded-lg p-3 mx-auto max-w-sm';
                useSuggestedBtn.classList.add('hidden');
            }
        };

        // --- UI CONTROL FUNCTIONS ---

        const switchTab = (tabId) => {
            document.querySelectorAll('[role="tabpanel"]').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });

            document.getElementById(`tab-panel-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabId}`).classList.add('active');
            document.getElementById(`tab-btn-${tabId}`).setAttribute('aria-selected', 'true');
            
            if (tabId === 'calendar') {
                renderCalendar();
            } else if (tabId === 'arsenal') {
                renderProductArsenal();
            }
        };
        
        const toggleAccordion = (headerId) => {
            const header = document.getElementById(headerId);
            const contentId = header.dataset.target;
            const content = document.getElementById(contentId);
            const chevron = document.getElementById(headerId.replace('-header', '-chevron'));

            header.classList.toggle('active');
            content.classList.toggle('hidden');
            chevron.classList.toggle('rotate-90');
            chevron.classList.toggle('rotate-0');
            chevron.textContent = content.classList.contains('hidden') ? '►' : '▼';
        };


        // --- INITIALIZATION & EVENT LISTENERS (COMPLETED) ---

        const initializeUI = () => {
            // 1. Initial State Load (via Firebase/Auth Listener)
            applySelectionsToUI();
            updateQuickCheck();

            // 2. Tab Listeners
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    switchTab(e.currentTarget.id.replace('tab-btn-', ''));
                });
            });

            // 3. Wash Routine Listeners
            document.querySelectorAll('.wash-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentWash = e.currentTarget.dataset.protocol;
                    saveLastSelection();
                    applySelectionsToUI();
                });
            });

            // 4. Style Goal Listeners
            document.querySelectorAll('.style-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentStyle = e.currentTarget.dataset.protocol;
                    saveLastSelection();
                    applySelectionsToUI();
                });
            });
            
            // 5. Accordion Listeners
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => toggleAccordion(header.id));
            });
            
            // 6. Log and Clear Buttons
            document.getElementById('log-completion-btn').addEventListener('click', logCompletion);
            document.getElementById('clear-selection-btn').addEventListener('click', () => {
                currentWash = null;
                currentStyle = null;
                saveLastSelection();
                applySelectionsToUI();
            });
            
            // 7. Calendar Navigation
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarMonthOffset--;
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarMonthOffset++;
                renderCalendar();
            });

            // Initial render for Calendar and Arsenal (will happen when tabs are switched)
            renderCalendar();
        };

        // Start the application by setting up Firebase
        setupFirebase();
    </script>

</body>
</html>
