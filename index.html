<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hair Blueprint Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .log-entry:nth-child(odd) {
            background-color: #f9f9fa;
        }
        /* Custom scrollbar for log section */
        #log-entries::-webkit-scrollbar {
            width: 8px;
        }
        #log-entries::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- Header -->
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800 tracking-tight">Hair Blueprint Tracker</h1>
        <p class="text-gray-500 mt-2">Log and track your hair products and routine.</p>
    </header>

    <!-- Credentials Display (REVERTED BACK TO VISIBLE) -->
    <div id="credentials" class="max-w-7xl mx-auto mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
        <p class="text-xs text-gray-700">App ID: <span id="app-id-display" class="font-mono text-indigo-700">...</span></p>
        <p class="text-xs text-gray-700">User ID: <span id="user-id-display" class="font-mono text-green-700">...</span></p>
    </div>

    <!-- Main Grid Layout -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">

        <!-- 1. Product Blueprints (Inputs and Settings) -->
        <section class="lg:col-span-1 card bg-white p-6 rounded-xl h-fit">
            <h2 class="text-2xl font-semibold text-indigo-700 mb-6">Product Blueprints</h2>

            <!-- Leave-In Conditioner Field -->
            <div class="mb-4">
                <label for="leaveIn" class="block text-sm font-medium text-gray-700 mb-1">Leave-In Conditioner</label>
                <input type="text" id="leaveIn" placeholder="e.g., KÃ©rastase Discipline Fluidissime" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            </div>
            
            <!-- Gel Field -->
            <div class="mb-4">
                <label for="gel" class="block text-sm font-medium text-gray-700 mb-1">Styling Gel/Cream</label>
                <input type="text" id="gel" placeholder="e.g., Devacurl Ultra Defining Gel" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            </div>

            <!-- Oil Field -->
            <div class="mb-6">
                <label for="oil" class="block text-sm font-medium text-gray-700 mb-1">Finishing Oil/Serum</label>
                <input type="text" id="oil" placeholder="e.g., Olaplex No. 7 Bonding Oil" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            </div>

            <!-- Save Settings Button -->
            <button id="saveSettingsBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01]">
                Save Blueprints
            </button>
        </section>

        <!-- 2. Daily Log Input -->
        <section class="lg:col-span-1 card bg-white p-6 rounded-xl h-fit">
            <h2 class="text-2xl font-semibold text-green-600 mb-6">Routine Log</h2>

            <!-- Date Input -->
            <div class="mb-4">
                <label for="logDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                <input type="date" id="logDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
            </div>

            <!-- Routine Type Select -->
            <div class="mb-4">
                <label for="routineType" class="block text-sm font-medium text-gray-700 mb-1">Routine Type</label>
                <select id="routineType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 bg-white">
                    <option value="wash">Wash Day</option>
                    <option value="refresh">Refresh</option>
                    <option value="dry">Dry Style/Day 2+</option>
                </select>
            </div>

            <!-- Notes Textarea -->
            <div class="mb-6">
                <label for="logNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes / Results</label>
                <textarea id="logNotes" rows="3" placeholder="How did the hair feel? What worked well?" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150"></textarea>
            </div>

            <!-- Log Button -->
            <button id="logBtn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition duration-300 transform hover:scale-[1.01]">
                Log Entry
            </button>
        </section>

        <!-- 3. History Log -->
        <section class="lg:col-span-1 card bg-white p-6 rounded-xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Recent History</h2>
            </div>
            
            <!-- Dynamic Log Content -->
            <div id="log-entries" class="space-y-3 overflow-y-auto max-h-[400px] md:max-h-[600px]">
                <!-- Log entries will be inserted here by JavaScript -->
                <p class="text-center text-gray-400 mt-4">Loading log entries...</p>
            </div>
        </section>
    </main>
    
    <!-- Toast/Modal for messages (instead of alert) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg font-medium text-gray-800"></p>
            <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="mt-4 bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-300">
                Close
            </button>
        </div>
    </div>

    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc, orderBy, limit, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level to help with debugging
        setLogLevel('Debug');

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = null;
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Failed to parse firebase config:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = '';
        let currentSettings = { leaveIn: '', gel: '', oil: '' };
        
        // --- Utility Functions ---

        /** Shows a message in a custom modal instead of using alert() */
        function showMessage(message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 3000);
        }

        /** Converts a date string to a human-readable format */
        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // --- Firebase Core Functions ---

        /** Initializes Firebase app and handles authentication */
        async function initializeFirebase() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing or invalid. Data saving will not work.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set the visible App ID
                document.getElementById('app-id-display').textContent = appId;
                
                // 1. Authentication Check
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid; // ESSENTIAL: Capture the unique user ID
                        
                        // Set the visible User ID
                        document.getElementById('user-id-display').textContent = userId;
                        console.log("Firebase initialized. User ID:", userId);
                        
                        // Proceed to load data once authenticated
                        await loadSettings();
                        listenToLogEntries();

                    } else if (initialAuthToken) {
                        // 2. Use initial token for silent sign-in (Canvas environment)
                        await signInWithCustomToken(auth, initialAuthToken);
                        
                    } else {
                        // 3. Fallback to anonymous sign-in (External URL)
                        console.log("No initial token found. Signing in anonymously.");
                        await signInAnonymously(auth); 
                        // Note: onAuthStateChanged will fire again after anonymous sign-in completes.
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }
        
        // --- Firestore Path Generation ---
        
        /** Constructs the Firestore path for the user's private data (REQUIRED for security) */
        function getCollectionRef(collectionName) {
            // Path: /artifacts/{appId}/users/{userId}/{collectionName}
            return collection(db, 'artifacts', appId, 'users', userId, collectionName);
        }

        // --- Settings (Blueprints) Management ---

        /** Saves the current product blueprint settings */
        async function saveSettings() {
            if (!userId) {
                showMessage("Authentication pending. Please wait a moment before saving.");
                return;
            }

            const leaveIn = document.getElementById('leaveIn').value.trim();
            const gel = document.getElementById('gel').value.trim();
            const oil = document.getElementById('oil').value.trim();

            const settingsData = { leaveIn, gel, oil };
            
            try {
                // Settings are stored as a single document under the 'settings' collection
                const settingsDocRef = doc(getCollectionRef('hair-blueprint-settings'), 'main');
                await setDoc(settingsDocRef, settingsData);
                currentSettings = settingsData;
                showMessage("Blueprints saved successfully!");
            } catch (e) {
                console.error("Error saving settings:", e);
                showMessage("Error saving blueprints. Check console for details.");
            }
        }

        /** Loads product blueprint settings from Firestore */
        async function loadSettings() {
            if (!userId) return;

            try {
                const settingsDocRef = doc(getCollectionRef('hair-blueprint-settings'), 'main');
                // Use onSnapshot for real-time updates on settings (if another device changes them)
                onSnapshot(settingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentSettings = data;
                        document.getElementById('leaveIn').value = data.leaveIn || '';
                        document.getElementById('gel').value = data.gel || '';
                        document.getElementById('oil').value = data.oil || '';
                        console.log("Settings loaded/updated.");
                    } else {
                        console.log("No saved settings found. Using empty defaults.");
                    }
                });
            } catch (e) {
                console.error("Error loading settings:", e);
            }
        }

        // --- Log Entry Management ---
        
        /** Adds a new routine log entry to Firestore */
        async function saveLogEntry() {
            if (!userId) {
                showMessage("Authentication pending. Cannot log entry yet.");
                return;
            }

            const logDate = document.getElementById('logDate').value;
            const routineType = document.getElementById('routineType').value;
            const logNotes = document.getElementById('logNotes').value.trim();

            if (!logDate) {
                showMessage("Please select a date for the log entry.");
                return;
            }

            const newEntry = {
                date: logDate,
                routineType: routineType,
                notes: logNotes,
                leaveIn: currentSettings.leaveIn,
                gel: currentSettings.gel,
                oil: currentSettings.oil,
                timestamp: serverTimestamp()
            };
            
            try {
                await addDoc(getCollectionRef('hair-blueprint-log'), newEntry);
                showMessage("Routine logged successfully!");
                document.getElementById('logNotes').value = ''; // Clear notes after successful log
            } catch (e) {
                console.error("Error logging entry:", e);
                showMessage("Error logging entry. Check console.");
            }
        }

        /** Listens to log entries in real-time and updates the UI */
        function listenToLogEntries() {
            if (!userId) return;

            const logRef = getCollectionRef('hair-blueprint-log');
            // Query: Order by timestamp descending, limit to 20 recent entries
            const q = query(logRef, orderBy("timestamp", "desc"), limit(20));
            
            // Real-time listener using onSnapshot
            onSnapshot(q, (snapshot) => {
                const logEntriesContainer = document.getElementById('log-entries');
                logEntriesContainer.innerHTML = ''; // Clear current entries

                if (snapshot.empty) {
                    logEntriesContainer.innerHTML = '<p class="text-center text-gray-500 py-8">No log entries yet. Start logging!</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const entry = doc.data();
                    const entryId = doc.id;
                    logEntriesContainer.appendChild(createLogElement(entry, entryId));
                });
            }, (error) => {
                console.error("Error listening to log entries:", error);
                logEntriesContainer.innerHTML = '<p class="text-center text-red-500 py-8">Error loading history.</p>';
            });
        }
        
        /** Creates the HTML structure for a single log entry */
        function createLogElement(entry, entryId) {
            const div = document.createElement('div');
            div.className = 'log-entry p-4 rounded-lg border border-gray-100 shadow-sm relative';
            
            const dateStr = entry.date ? formatDate(entry.date) : 'N/A';
            
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <span class="inline-block text-xs font-medium px-2 py-0.5 rounded-full ${entry.routineType === 'wash' ? 'bg-indigo-100 text-indigo-700' : entry.routineType === 'refresh' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                            ${entry.routineType.toUpperCase()}
                        </span>
                        <p class="text-sm text-gray-400 mt-1">${dateStr}</p>
                    </div>
                    <button data-id="${entryId}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors">
                        <!-- Trash Icon SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div class="mt-3">
                    <p class="text-gray-800 font-medium mb-2">Products Used:</p>
                    <ul class="text-sm text-gray-600 space-y-1 pl-4 list-disc">
                        <li>**Leave-In:** ${entry.leaveIn || 'N/A'}</li>
                        <li>**Gel:** ${entry.gel || 'N/A'}</li>
                        <li>**Oil:** ${entry.oil || 'N/A'}</li>
                    </ul>
                </div>
                ${entry.notes ? `<p class="mt-3 text-sm italic text-gray-500 border-t pt-3 border-gray-100">${entry.notes}</p>` : ''}
            `;
            return div;
        }

        /** Deletes a log entry */
        async function deleteLogEntry(entryId) {
            if (!userId) {
                showMessage("Authentication pending. Cannot delete entry.");
                return;
            }
            
            // IMPORTANT: Since we don't use confirmation dialogs (alert/confirm), we delete directly. 
            // In a production app, you'd add a custom modal confirmation.
            
            try {
                const docRef = doc(getCollectionRef('hair-blueprint-log'), entryId);
                await deleteDoc(docRef);
                showMessage("Entry deleted.");
            } catch (e) {
                console.error("Error deleting document:", e);
                showMessage("Error deleting entry. Check console.");
            }
        }


        // --- Event Listeners and Initial Setup ---
        
        window.onload = function() {
            // Set today's date as default for the log date picker
            document.getElementById('logDate').valueAsDate = new Date();
            
            // Attach main button listeners
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('logBtn').addEventListener('click', saveLogEntry);

            // Listener for deleting log entries (event delegation)
            document.getElementById('log-entries').addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) {
                    const entryId = deleteButton.getAttribute('data-id');
                    if (entryId) {
                        deleteLogEntry(entryId);
                    }
                }
            });

            // Start the Firebase process
            initializeFirebase();
        }
        
    </script>
</body>
</html>
